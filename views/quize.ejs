<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .quiz-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .quiz-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #667eea;
        }
        
        /* Progress Bar */
        .progress-container {
            margin: 20px 0;
            background-color: #e0e0e0;
            border-radius: 10px;
            padding: 3px;
        }
        .progress-bar {
            height: 20px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
            width: 0%;
        }
        
        /* Question Container */
        .question-container {
            display: none;
            margin-bottom: 25px;
            padding: 30px;
            border: 2px solid #667eea;
            border-radius: 12px;
            background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
        }
        .question-container.active {
            display: block;
            animation: fadeInUp 0.5s ease;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .question-number {
            color: #667eea;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .question-text {
            font-size: 18px;
            margin-bottom: 20px;
            color: #333;
            line-height: 1.6;
            font-weight: 500;
        }
        .option {
            margin: 12px 0;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
            background: white;
        }
        .option:hover {
            border-color: #667eea;
            background: #f8f9ff;
            transform: translateX(5px);
        }
        .option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }
        .option input[type="radio"] {
            margin-right: 12px;
            transform: scale(1.2);
        }
        .option label {
            cursor: pointer;
            font-size: 16px;
            display: block;
            width: 100%;
        }
        
        /* Navigation */
        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }
        .nav-btn {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        .nav-btn:hover:not(:disabled) {
            background: #5a6fd8;
            transform: translateY(-2px);
        }
        .nav-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .nav-btn.next {
            background: #28a745;
        }
        .nav-btn.next:hover:not(:disabled) {
            background: #218838;
        }
        .nav-btn.submit {
            background: #dc3545;
        }
        .nav-btn.submit:hover:not(:disabled) {
            background: #c82333;
        }
        
        /* Question Navigator */
        .question-navigator {
            text-align: center;
            margin: 20px 0;
        }
        .nav-dots {
            display: inline-flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .nav-dot {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #ddd;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .nav-dot:hover {
            border-color: #667eea;
            transform: scale(1.1);
        }
        .nav-dot.current {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        .nav-dot.answered {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }
        
        .timer {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #667eea;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: bold;
            z-index: 1000;
        }
        
        /* Summary View */
        .quiz-summary {
            display: none;
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
            border-radius: 12px;
            border: 2px solid #667eea;
        }
        .quiz-summary.active {
            display: block;
            animation: fadeInUp 0.5s ease;
        }
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-item {
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        .submit-btn {
            background: #dc3545;
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }
        .submit-btn:hover {
            background: #c82333;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="timer" id="timer">Time: 00:00</div>
    
    <div class="quiz-container">
        <div class="quiz-header">
            <h1>Quiz</h1>
            <p>Navigate through questions using the controls below</p>
            
            <!-- Progress Bar -->
            <div class="progress-container">
                <div class="progress-bar" id="progressBar">0%</div>
            </div>
            
            <!-- Question Navigator Dots -->
            <div class="question-navigator">
                <div class="nav-dots" id="navDots"></div>
            </div>
        </div>

        <form id="quizForm" method="POST" action="/quiz/<%= req.params.module %>/<%= req.params.quizId %>/submit">
            <% if (quiz && quiz.length > 0) { %>
                <% quiz.forEach((question, index) => { %>
                    <div class="question-container <%= index === 0 ? 'active' : '' %>" data-question="<%= index %>">
                        <div class="question-number">
                            <span>Question <%= index + 1 %> of <%= quiz.length %></span>
                            <span>Quiz ID: <%= question.id || (index + 1) %></span>
                        </div>
                        <div class="question-text"><%= question.text %></div>
                        
                        <% question.options.forEach((option, optionIndex) => { %>
                            <div class="option">
                                <input type="radio" 
                                       id="q<%= index %>_<%= optionIndex %>" 
                                       name="answers[<%= index %>]" 
                                       value="<%= optionIndex %>">
                                <label for="q<%= index %>_<%= optionIndex %>"><%= option %></label>
                            </div>
                        <% }); %>
                    </div>
                <% }); %>
                
                <!-- Quiz Summary -->
                <div class="quiz-summary" id="quizSummary">
                    <h2>Quiz Summary</h2>
                    <p>Review your answers before submitting</p>
                    
                    <div class="summary-stats">
                        <div class="stat-item">
                            <div class="stat-number" id="totalQuestions"><%= quiz.length %></div>
                            <div>Total Questions</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="answeredCount">0</div>
                            <div>Answered</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="unansweredCount"><%= quiz.length %></div>
                            <div>Remaining</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="timeSpentDisplay">00:00</div>
                            <div>Time Spent</div>
                        </div>
                    </div>
                    
                    <button type="submit" class="submit-btn">Submit Quiz</button>
                    <br><br>
                    <button type="button" class="nav-btn" onclick="showQuestion(Math.max(0, currentQuestion))">Back to Questions</button>
                </div>
                
            <% } else { %>
                <div class="question-container active">
                    <div class="question-text">
                        <h2>No Questions Available</h2>
                        <p>This quiz does not contain any questions.</p>
                        <a href="/modules/<%= req.params.module %>" class="nav-btn">Back to Module</a>
                    </div>
                </div>
            <% } %>

            <!-- Navigation Controls -->
            <% if (quiz && quiz.length > 0) { %>
            <div class="navigation">
                <button type="button" class="nav-btn" id="prevBtn" onclick="previousQuestion()">Previous</button>
                <span id="questionInfo">Question 1 of <%= quiz.length %></span>
                <button type="button" class="nav-btn next" id="nextBtn" onclick="nextQuestion()">Next</button>
            </div>
            <% } %>

            <input type="hidden" name="timeSpent" id="timeSpent" value="0:00">
        </form>
    </div>

    <script>
        // Quiz state
        let currentQuestion = 0;
        const totalQuestions = <%= quiz ? quiz.length : 0 %>;
        let startTime = new Date();
        let timerInterval;
        
        // Initialize quiz only if we have questions
        document.addEventListener('DOMContentLoaded', function() {
            if (totalQuestions > 0) {
                initializeQuiz();
                startTimer();
                updateNavigation();
                updateProgress();
                createNavigationDots();
                
                // Initialize any pre-selected options
                document.querySelectorAll('.question-container').forEach(container => {
                    updateOptionSelection(container);
                });
            }
        });
        
        function initializeQuiz() {
            // Add click handlers for options
            document.querySelectorAll('.option').forEach(option => {
                option.addEventListener('click', function(e) {
                    // Prevent double-click issues
                    e.preventDefault();
                    
                    const radio = this.querySelector('input[type="radio"]');
                    if (radio) {
                        radio.checked = true;
                        updateOptionSelection(this.closest('.question-container'));
                        updateProgress();
                        updateNavigationDots();
                    }
                });
            });
            
            // Show first question
            showQuestion(0);
        }
        
        function showQuestion(questionIndex) {
            if (questionIndex < 0 || questionIndex >= totalQuestions) return;
            
            // Hide all questions and summary
            document.querySelectorAll('.question-container').forEach(q => q.classList.remove('active'));
            document.getElementById('quizSummary')?.classList.remove('active');
            
            // Show current question
            const questionElement = document.querySelector(`[data-question="${questionIndex}"]`);
            if (questionElement) {
                questionElement.classList.add('active');
                currentQuestion = questionIndex;
                updateNavigation();
                updateNavigationDots();
                
                // Scroll to top smoothly
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }
        
        function nextQuestion() {
            if (currentQuestion < totalQuestions - 1) {
                showQuestion(currentQuestion + 1);
            } else {
                showSummary();
            }
        }
        
        function previousQuestion() {
            if (currentQuestion > 0) {
                showQuestion(currentQuestion - 1);
            }
        }
        
        function showSummary() {
            document.querySelectorAll('.question-container').forEach(q => q.classList.remove('active'));
            const summaryElement = document.getElementById('quizSummary');
            if (summaryElement) {
                summaryElement.classList.add('active');
                updateSummaryStats();
                currentQuestion = -1; // Special state for summary
                updateNavigation();
                updateNavigationDots();
                
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }
        
        function updateNavigation() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const questionInfo = document.getElementById('questionInfo');
            
            if (!prevBtn || !nextBtn || !questionInfo) return;
            
            if (currentQuestion === -1) {
                // Summary view
                prevBtn.textContent = 'Back to Questions';
                nextBtn.style.display = 'none';
                questionInfo.textContent = 'Quiz Summary';
                prevBtn.onclick = () => showQuestion(totalQuestions - 1);
                prevBtn.disabled = false;
            } else {
                prevBtn.textContent = 'Previous';
                prevBtn.onclick = previousQuestion;
                nextBtn.style.display = 'block';
                nextBtn.onclick = nextQuestion;
                
                prevBtn.disabled = currentQuestion === 0;
                
                if (currentQuestion === totalQuestions - 1) {
                    nextBtn.textContent = 'Review & Submit';
                    nextBtn.className = 'nav-btn submit';
                } else {
                    nextBtn.textContent = 'Next';
                    nextBtn.className = 'nav-btn next';
                }
                
                questionInfo.textContent = `Question ${currentQuestion + 1} of ${totalQuestions}`;
            }
        }
        
        function updateProgress() {
            const answeredQuestions = getAnsweredQuestions().length;
            const percentage = totalQuestions > 0 ? Math.round((answeredQuestions / totalQuestions) * 100) : 0;
            const progressBar = document.getElementById('progressBar');
            
            if (progressBar) {
                progressBar.style.width = percentage + '%';
                progressBar.textContent = percentage + '%';
            }
        }
        
        function createNavigationDots() {
            const navDots = document.getElementById('navDots');
            if (!navDots) return;
            
            navDots.innerHTML = '';
            
            for (let i = 0; i < totalQuestions; i++) {
                const dot = document.createElement('div');
                dot.className = 'nav-dot';
                dot.textContent = i + 1;
                dot.onclick = () => showQuestion(i);
                dot.title = `Go to Question ${i + 1}`;
                navDots.appendChild(dot);
            }
        }
        
        function updateNavigationDots() {
            const dots = document.querySelectorAll('.nav-dot');
            const answeredQuestions = getAnsweredQuestions();
            
            dots.forEach((dot, index) => {
                dot.classList.remove('current', 'answered');
                
                if (index === currentQuestion) {
                    dot.classList.add('current');
                } else if (answeredQuestions.includes(index)) {
                    dot.classList.add('answered');
                }
            });
        }
        
        function updateOptionSelection(questionContainer) {
            const options = questionContainer.querySelectorAll('.option');
            const selectedRadio = questionContainer.querySelector('input[type="radio"]:checked');
            
            options.forEach(option => {
                option.classList.remove('selected');
            });
            
            if (selectedRadio) {
                selectedRadio.closest('.option').classList.add('selected');
            }
        }
        
        function getAnsweredQuestions() {
            const answered = [];
            for (let i = 0; i < totalQuestions; i++) {
                const radio = document.querySelector(`input[name="answers[${i}]"]:checked`);
                if (radio) {
                    answered.push(i);
                }
            }
            return answered;
        }
        
        function updateSummaryStats() {
            const answeredQuestions = getAnsweredQuestions();
            const totalQuestionsElement = document.getElementById('totalQuestions');
            const answeredCountElement = document.getElementById('answeredCount');
            const unansweredCountElement = document.getElementById('unansweredCount');
            const timeSpentDisplayElement = document.getElementById('timeSpentDisplay');
            
            if (totalQuestionsElement) totalQuestionsElement.textContent = totalQuestions;
            if (answeredCountElement) answeredCountElement.textContent = answeredQuestions.length;
            if (unansweredCountElement) unansweredCountElement.textContent = totalQuestions - answeredQuestions.length;
            if (timeSpentDisplayElement) timeSpentDisplayElement.textContent = document.getElementById('timeSpent').value;
        }
        
        // Timer functionality
        function startTimer() {
            timerInterval = setInterval(updateTimer, 1000);
        }
        
        function updateTimer() {
            const now = new Date();
            const elapsed = now - startTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            const timerElement = document.getElementById('timer');
            const timeSpentElement = document.getElementById('timeSpent');
            
            if (timerElement) timerElement.textContent = `Time: ${timeString}`;
            if (timeSpentElement) timeSpentElement.value = timeString;
        }
        
        // Form submission
        const quizForm = document.getElementById('quizForm');
        if (quizForm) {
            quizForm.addEventListener('submit', function(e) {
                clearInterval(timerInterval);
                
                // Final validation
                const answeredQuestions = getAnsweredQuestions();
                if (answeredQuestions.length < totalQuestions) {
                    const confirmSubmit = window.confirm(`You have ${totalQuestions - answeredQuestions.length} unanswered questions. Are you sure you want to submit?`);
                    if (!confirmSubmit) {
                        e.preventDefault();
                        startTimer(); // Restart timer if they cancel
                        return;
                    }
                }
                
                console.log('Quiz submitted with', answeredQuestions.length, 'out of', totalQuestions, 'answers');
            });
        }
        
        // Keyboard navigation
        document.addEventListener('keydown', function(e) {
            if (totalQuestions === 0 || currentQuestion === -1) return; // Don't navigate if no questions or in summary
            
            if (e.key === 'ArrowLeft' && currentQuestion > 0) {
                e.preventDefault();
                previousQuestion();
            } else if (e.key === 'ArrowRight') {
                e.preventDefault();
                if (currentQuestion < totalQuestions - 1) {
                    nextQuestion();
                } else {
                    showSummary();
                }
            }
        });
        
        // Debug information
        console.log('Quiz initialized with', totalQuestions, 'questions');
        if (totalQuestions > 0) {
            console.log('Quiz data structure appears valid');
        } else {
            console.log('No quiz questions found');
        }
    </script>
</body>
</html>